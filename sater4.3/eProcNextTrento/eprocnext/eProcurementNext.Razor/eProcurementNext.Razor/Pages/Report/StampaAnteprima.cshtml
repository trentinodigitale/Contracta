@page "/Report/StampaAnteprima.asp"
@inject eProcurementNext.Session.ISession session;
@using eProcurementNext.CommonDB
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.print_documentModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.CommonModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.securityModel;
@using static eProcurementNext.Razor.Pages.Report.StampaAnteprimaModel;
@using Microsoft.VisualBasic;
@model eProcurementNext.Razor.Pages.Report.StampaAnteprimaModel
@using static eProcurementNext.Session.SessionMiddleware
@{
	CommonDbFunctions cdf = new();
	LoadSession(HttpContext, session);
	EprocResponse htmlToReturn = new();
	objDoc = PrintDocument(session, htmlToReturn, HttpContext, Response, Request);//PrintDocument ok

}
@{

	htmlToReturn.Write($@"<html>

	<head>
		<meta http-equiv=""Content-Type"" content=""text/html; charset=utf-8""/>
		<title>Verbale di Gara</title>

		<style>

			.contenitore_stampa
			{{
				width:950;
				margin: 0 auto;
			}}

		</style>

	</head>

	<body>

	<div class=""contenitore_stampa"">");


	//'-- tolti gli stili per far vincere quelli usati nei template
	//'<link rel="stylesheet" href="CSS/verbaledigara.css" type="text/css" media="screen,projection">
	//'<!-- #Include File="css/verbaledigaraprint.css" -->

	//'--DIV CONTENTITORE DELLA PAGINA CORRENTE
	//'Response.Write "<table id=""TABLE_CONTENTITORE"" align=""center"" style=""width:25cm; margin-left:2cm; margin-right:2cm;"">" & vbCrLf 
	htmlToReturn.Write($@"<table>" + Environment.NewLine);

	//'--DISEGNO TESTATA DELLA PAGINA
	TestataPagina();

	int nr = DOC_NumRow("DETTAGLI", "");

	if (nr >= 0)
	{

		//'--DIV CONTENTITORE DEL CORPO DELLA PRIMA PAGINA
		htmlToReturn.Write($@"<tr height=""32cm"" width=""100%""><td id=TD_CORPO style=""height:32cm; width:100%;"" height=""100%"" width=""100%"" border=1>" + Environment.NewLine);

		for (int i = 0; i <= nr - 1; i++)
		{ //to nr-1

			//'--per tutte le sezioni selezionate
			//'//if DOC_FieldRowTecnical( "DETTAGLI", "SelRow", i ) = "1" then

			string strSection = DOC_FieldRowTecnical("DETTAGLI", "DescrizioneEstesa", i);

			//'--gestione del salto pagina
			int nPosSaltoPagina = 0;
			nPosSaltoPagina = Strings.InStr(1, strSection, "@@@SALTOPAGINA@@@");

			if (nPosSaltoPagina > 0)
			{


				while (nPosSaltoPagina > 0)
				{


					//'--DISEGNO la parte che deve andare nel corpo della pagina  corrente
					string strCurrBody = Strings.Left(strSection, nPosSaltoPagina - 1);

					htmlToReturn.Write(bonificaHtmlDaXSS(strCurrBody) + Environment.NewLine);

					//'--CHIUSURA DIV CORPO DELLA PAGINA CORRENTE
					htmlToReturn.Write($@"</tr>" + Environment.NewLine);

					//'--DISEGNO PIEPAGINA
					PiePagina();

					//'--CHIUSURA DIV CONTENTITORE PAGINA CORRENTE
					htmlToReturn.Write($@"</table>" + Environment.NewLine + $@"</div>");

					//'--INSERIMENTO SALTO PAGINA
					SaltoPagina(htmlToReturn);

					htmlToReturn.Write($@"<div class=""contenitore_stampa"">");

					//'--DIV CONTENTITORE DELLA NUOVA PAGINA
					//'Response.Write "<table id=TABLE_CONTENTITORE align=center style=""width:25cm; margin-left:1cm; margin-right:1cm;"">" & vbCrLf 
					htmlToReturn.Write($@"<table>");


					//'--DISEGNO TESTATA DELLA NUOVA PAGINA
					TestataPaginaSuccessive();

					//'--DIV CONTENTITORE DEL CORPO DELLA NUOVA PAGINA
					//'Response.Write "<tr height=""35.2cm"" width=""100%""><td id=TD_CORPO style=""height:35.2cm; width:100%;"" height=""100%"" width=""100%"">" & vbCrLf 
					htmlToReturn.Write($@"<tr width=""100%""><td id=TD_CORPO style=""width:100%;"" height=""100%"" width=""100%"">" + Environment.NewLine);

					//'--DISEGNO la parte che deve andare nel corpo della NUOVA PAGINA
					strSection = Strings.Mid(strSection, nPosSaltoPagina + 17);

					nPosSaltoPagina = 0;
					nPosSaltoPagina = Strings.InStr(1, strSection, "@@@SALTOPAGINA@@@");


				}


				htmlToReturn.Write(bonificaHtmlDaXSS(strSection) + Environment.NewLine);

			}
			else
			{

				htmlToReturn.Write(bonificaHtmlDaXSS(strSection) + Environment.NewLine);

			}

			//'//end if	
		}

		//'--CHIUSURA DIV CORPO DELLA PAGINA CORRENTE
		htmlToReturn.Write($@"</td></tr >" + Environment.NewLine);

	}
	PiePagina();

	//'--CHIUSURA DIV CONTENTITORE PAGINA CORRENTE
	htmlToReturn.Write($@"</table >" + Environment.NewLine);



	void TestataPagina()
	{

		//'--DIV CONTENTITORE DELLA TESTATA DELLA PAGINA
		htmlToReturn.Write($@"<tr id=TR_TESTATA>" + Environment.NewLine);
		htmlToReturn.Write($@"<td id=TR_TESTATA >");
		htmlToReturn.Write(DOC_Field("TESTATA2", "Testata") + Environment.NewLine);
		htmlToReturn.Write($@"</td>");
		//'Response.write "testata 1"
		htmlToReturn.Write($@"</tr>" + Environment.NewLine);

	}

	void TestataPaginaSuccessive()
	{

		//'--DIV CONTENTITORE DELLA TESTATA DELLA PAGINA
		htmlToReturn.Write($@"<tr id=TR_TESTATA_SUCCESSIVA>" + Environment.NewLine);
		htmlToReturn.Write($@"<td id=TR_TESTATA_SUCCESSIVA>");
		htmlToReturn.Write(DOC_Field("TESTATA2", "Testata2") + Environment.NewLine);

		htmlToReturn.Write($@"</td>");
		//'Response.write "testata 2"
		htmlToReturn.Write($@"</tr >" + Environment.NewLine);

	}

	void PiePagina()
	{

		//'--DIV CONTENTITORE DEL PIEPAGINA DELLA PAGINA
		htmlToReturn.Write($@"<tr id=TR_PIEPAGINA>" + Environment.NewLine);

		htmlToReturn.Write($@"<td id=TD_PIEPAGINA>");

		htmlToReturn.Write(DOC_Field("TESTATA2", "PiePagina") + Environment.NewLine);

		htmlToReturn.Write($@"</td>");
		//'Response.write "pi� pagina"
		htmlToReturn.Write($@"</tr >" + Environment.NewLine);

	}


	htmlToReturn.Write($@"</div>
		</body>
		</html>
	");




		//'-- Testo aggiunto in automatico per liberare la memoria dei nuovi report

	try
	{
		FreeMemDocument(session);
	}
	catch
	{

	}

	

}
@Html.Raw(htmlToReturn.Out())