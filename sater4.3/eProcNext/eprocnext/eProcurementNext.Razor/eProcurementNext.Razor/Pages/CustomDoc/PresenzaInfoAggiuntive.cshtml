@page "/CustomDoc/PresenzaInfoAggiuntive.asp"
@inject eProcurementNext.Session.ISession session;
@using eProcurementNext.CommonDB;
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.securityModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.verificaBrowserModel;
@using static eProcurementNext.Razor.Pages.CustomDoc.PresenzaInfoAggiuntiveModel;
@using Microsoft.VisualBasic;
@model eProcurementNext.Razor.Pages.CustomDoc.PresenzaInfoAggiuntiveModel
@using static eProcurementNext.Session.SessionMiddleware
@{
	CommonDbFunctions cdf = new();
	LoadSession(HttpContext, session);
	EprocResponse htmlToReturn = new();
}
@{

	string classi_sel = GetParamURL(Request.QueryString.ToString(), "classi_sel").Replace("'", "''");
	string IDDOC = GetParamURL(Request.QueryString.ToString(), "IDDOC");

	//'-------------------------------------
	//'-- VALIDAZIONE DELL'INPUT UTENTE  ---
	//'-------------------------------------

	validate("IDDOC", IDDOC, TIPO_PARAMETRO_NUMERO, 0, "", 0, HttpContext, session);
	validate("classi_sel", Strings.Left(classi_sel.Replace("#", ""), 300), TIPO_PARAMETRO_STRING, SOTTO_TIPO_PARAMETRO_PAROLASINGOLA, "", 0, HttpContext, session);
	string strSQL = string.Empty;
	var sqlParams = new Dictionary<string, object?>();
	sqlParams.Add("@id", CInt(IDDOC));
	sqlParams.Add("@classi", classi_sel);
	if(!string.IsNullOrEmpty(classi_sel))
	{
		strSQL = "Declare @out int; Exec SP_CAN_INSERT_INFO_ADD_ISTANZA @id, @classi, @out output, 1; select @out as ret";

		TSRecordSet? rs = cdf.GetRSReadFromQuery_(strSQL, ApplicationCommon.Application.ConnectionString, sqlParams);
		if (rs is not null && rs.RecordCount > 0)
		{
			rs.MoveFirst();
			htmlToReturn.Write(CStr(rs["ret"]));
		}
		else
		{
			htmlToReturn.Write("");
		}
	}
	else
	{
		htmlToReturn.Write("");		
	}
	//'response.write strSQL
	//'response.end

	//'--recupero info azienda
}
@Html.Raw(htmlToReturn.Out())