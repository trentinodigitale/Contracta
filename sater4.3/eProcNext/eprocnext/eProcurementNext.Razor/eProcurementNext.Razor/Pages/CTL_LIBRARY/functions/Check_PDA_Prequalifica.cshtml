@page "/CTL_LIBRARY/functions/Check_PDA_Prequalifica.asp"
@inject eProcurementNext.Session.ISession session;
@using eProcurementNext.CommonDB
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.HTML.BasicFunction;
@model eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.Check_PDA_PrequalificaModel
@using static eProcurementNext.Session.SessionMiddleware
@{

	LoadSession(HttpContext, session);
	EprocResponse htmlToReturn = new(GetParamURL(HttpContext.Request.QueryString.ToString(), "XML_ATTACH_TYPE"));
}
@{
   
    string IDDOC = GetParamURL(Request.QueryString.ToString(), "IDDOC");
    string DOCUMENT = GetParamURL(Request.QueryString.ToString(), "DOCUMENT");

    string strResult = string.Empty;
    if (DOCUMENT == "DOCUMENTO_GENERICO")
    {
        //'--query per controllare se esiste una pda classica (169)
        var sqlParams = new Dictionary<string, object?>();
        sqlParams.Add("@IDDOC", CInt(IDDOC));
        string strSQL = "select mfIdMsg from MessageFields where mfIsubType=169 and mfFieldName='IdDoc_Bando' and mfFieldValue=(select IdDoc from TAB_MESSAGGI_FIELDS where IdMsg=@IDDOC )";
        CommonDbFunctions cdb = new();
        TSRecordSet rs = cdb.GetRSReadFromQuery_(strSQL, ApplicationCommon.Application.ConnectionString, sqlParams);
        if (rs.RecordCount >0)
        {
            strResult="1";
        }
        else
        {
            strResult="0";
        }
        //'--query per controllare se esiste una prequalifica (107)
        strSQL = "select mfIdMsg from MessageFields where mfIsubType=107 and mfFieldName='IdDoc_Bando' and mfFieldValue=(select IdDoc from TAB_MESSAGGI_FIELDS where IdMsg=@IDDOC)";
        TSRecordSet rs1 = cdb.GetRSReadFromQuery_(strSQL, ApplicationCommon.Application.ConnectionString, sqlParams);
        if (rs1.RecordCount >0)
        {
            strResult = $"{strResult}@@@1";
        }
        else
        {
            strResult = $"{strResult}@@@0";
        }
        //'--query per controllare se essite un apda microlotti
        strSQL = "select Id from CTL_DOC where TipoDoc='PDA_MICROLOTTI' and isnull(JumpCheck,'')='' and LinkedDoc=@IDDOC";
        TSRecordSet rs2 = cdb.GetRSReadFromQuery_(strSQL, ApplicationCommon.Application.ConnectionString, sqlParams);
        if (rs2.RecordCount >0)
        {
            strResult = $"{strResult}@@@1";
        }
        else
        {
            strResult = $"{strResult}@@@0";
        }
    }
    htmlToReturn.Write(strResult);

    throw new ResponseEndException(htmlToReturn.Out(), Response, "");
}@Html.Raw(htmlToReturn.Out())