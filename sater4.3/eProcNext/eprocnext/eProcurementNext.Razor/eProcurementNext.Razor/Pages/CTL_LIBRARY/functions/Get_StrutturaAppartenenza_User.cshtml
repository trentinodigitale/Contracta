@page "/CTL_LIBRARY/functions/Get_StrutturaAppartenenza_User.asp"
@inject eProcurementNext.Session.ISession session;
@using eProcurementNext.CommonDB
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.HTML.BasicFunction;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.CommonModel;
@using static eProcurementNext.Session.SessionMiddleware
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.securityModel;
@model eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.Get_StrutturaAppartenenza_UserModel
@{
    CommonDbFunctions cdf = new();
	LoadSession(HttpContext, session);
	EprocResponse htmlToReturn = new(GetParamURL(HttpContext.Request.QueryString.ToString(), "XML_ATTACH_TYPE"));
}
@{

	string idpfu = CStr(GetParamURL(Request.QueryString.ToString(), "idpfu"));

	//'*******************************************
	//'*****  VALIDAZIONE DELL'INPUT UTENTE  *****
	//'*******************************************

	validate("idpfu", GetParamURL(Request.QueryString.ToString(), "idpfu"), TIPO_PARAMETRO_STRING, SOTTO_TIPO_PARAMETRO_TABLE, "", 0, HttpContext, session);

	string strValore = string.Empty;

	//'--RICERCA PER CODICE FISCALE
	if (!string.IsNullOrEmpty(idpfu))
	{
		//'--cerco prima tra gli utenti dell'azienda collegata
		var sqlParams = new Dictionary<string, object?>();
		sqlParams.Add("@idpfu", CInt(idpfu));
		string strSQL = @"select attValue as Codice , isnull(DMV_DescML,'') as Descrizione
					from  
					ProfiliUtenteAttrib with (nolock)
					left join GESTIONE_DOMINIO_DIREZIONE with (nolock) on DMV_Cod=attValue and dmv_deleted=0
					where IdPfu = @idpfu and dztNome='plant' ";

		TSRecordSet rs = cdf.GetRSReadFromQuery_(strSQL, ApplicationCommon.Application.ConnectionString, sqlParams);
		if (rs.RecordCount > 0)
		{
			rs.MoveFirst(); 

			strValore = $"{CStr(rs["Codice"])}@@@{CStr(rs["Descrizione"])}";
		}
	}

	if (string.IsNullOrEmpty(strValore) || strValore == "@@@")
	{
		strValore = "@@@Seleziona";
	}

	htmlToReturn.Write(strValore);
	//response.end
}@Html.Raw(htmlToReturn.Out())