@page "/SITAR/LEGACY_SITAR_XML_GARA.asp"
@inject eProcurementNext.Session.ISession session;
@using System.IO;
@using eProcurementNext.CommonDB
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonDB.Basic;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.ctl_profiler
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.HTML.BasicFunction;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.securityModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.CommonModel;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.CtlProcess;
@using static eProcurementNext.Session.SessionMiddleware
@model eProcurementNext.Razor.Pages.SITAR.LEGACY_SITAR_XML_GARAModel
@{
    LoadSession(HttpContext, session);
    EprocResponse response = new();

    HttpContext.Response.ContentType = "TEXT/XML";
    if (CStr(GetParamURL(Request.QueryString.ToString(), "VIDEO")) != "1")
    {
        HttpContext.Response.Headers.Add("Content-Disposition", "attachment; filename=SITAR_XML_GARA.XML");
    }

    string vbTab = string.Empty;
    string RUP_Login = string.Empty;
    string RUP_Pwd = string.Empty;
    string CF_Ente = string.Empty;
    string SOVRASCR = string.Empty;

    string g_ID_DOC = string.Empty; // '-- ID della GARA
    string g_id_PDA = string.Empty;
    string g_SQLfilter = string.Empty;

    string STRsql = string.Empty;

    //'-- init
    vbTab = "    ";

    SOVRASCR = "true";
    RUP_Login = "RSOLSS70C49B034J";
    RUP_Pwd = "qwerty";
    CF_Ente = "91252510374";

    g_ID_DOC = GetParamURL(Request.QueryString.ToString(), "IDDOC");
    validate("IDDOC", g_ID_DOC, TIPO_PARAMETRO_INT, 0, "", 1, HttpContext, session);

    // '-- recupero l'elenco dei lotti dalla gara

    TSRecordSet rs_Lotti = new TSRecordSet();
    TSRecordSet rs_Lotti_PDA = new TSRecordSet();
    TSRecordSet rs_Gara = new TSRecordSet();
    TSRecordSet rs_ComAggiudic = new TSRecordSet();
    TSRecordSet rs_Aziende = new TSRecordSet();
    TSRecordSet rs_RapLeg = new TSRecordSet();

    rs_Gara = GetRS("select * from SITAR_DATI_GARA where idGara = " + g_ID_DOC);

    //'-- gestire la mancanza della gara
    CF_Ente = CStr(GetValueFromRS(rs_Gara.Fields["CFEIN"]));

    response.Write(@"<soapenv:Envelope xmlns:soapenv='http://schemas.xmlsoap.org/soap/envelope/' xmlns:bean='http://beans.ws.vigilanza.sil.eldasoft.it'>
   <soapenv:Header/>
   <soapenv:Body>
      <bean:istanziaGara>
         <bean:login>
			<bean:login>" + RUP_Login + @"</bean:login>
			<bean:password>" + RUP_Pwd + @"</bean:password>
		</bean:login>
        <bean:garaLotti>
			<bean:testata>
				<bean:CFEIN>" + CF_Ente + @"</bean:CFEIN>
				<bean:SOVRASCR>" + SOVRASCR + @"</bean:SOVRASCR>
			</bean:testata>
			<bean:oggettoXML>
				<![CDATA[");

    response.Write(@"<bean:richiestaSincrona_IstanzaGara test='false' xmlns:bean='http://beans.vigilanza.sil.eldasoft.it'>
	<bean:Gara>

		<bean:W3OGGETTO1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3OGGETTO1"]))) + @"</bean:W3OGGETTO1>
		<bean:W3IDGARA>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3IDGARA"]))) + @"</bean:W3IDGARA>
		<bean:W3I_GARA>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3I_GARA"]))) + @"</bean:W3I_GARA>
		<bean:W3DGURI>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3DGURI"]))) + @"</bean:W3DGURI>
		<bean:W3DSCADB>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3DSCADB"]))) + @"</bean:W3DSCADB>
		<bean:W9GAMOD_IND>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W9GAMOD_IND"]))) + @"</bean:W9GAMOD_IND>
		<bean:W9GAFLAG_ENT>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W9GAFLAG_ENT"]))) + @"</bean:W9GAFLAG_ENT>
		<bean:W3TIPOAPP>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3TIPOAPP"]))) + @"</bean:W3TIPOAPP>
		<bean:W3ID_TIPOL>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3ID_TIPOL"]))) + @"</bean:W3ID_TIPOL>
		<bean:W9GASTIPULA>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W9GASTIPULA"]))) + @"</bean:W9GASTIPULA>


		<bean:rup>
			<bean:CFTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["CFTEC1"]))) + @"</bean:CFTEC1>
			<bean:COGTEI>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["COGTEI"]))) + @"</bean:COGTEI>

			<bean:NOMETEI>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["NOMETEI"]))) + @"</bean:NOMETEI>
			<bean:INDTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["INDTEC1"]))) + @"</bean:INDTEC1>

			<bean:NCITEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["NCITEC1"]))) + @"</bean:NCITEC1>
			<bean:LOCTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["LOCTEC1"]))) + @"</bean:LOCTEC1>
			<bean:PROTEC>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["PROTEC"]))) + @"</bean:PROTEC>
			<bean:CAPTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["CAPTEC1"]))) + @"</bean:CAPTEC1>
			<bean:G_CITTECI>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["G_CITTECI"]))) + @"</bean:G_CITTECI>
			<bean:TELTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["TELTEC1"]))) + @"</bean:TELTEC1>
			<bean:FAXTEC1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["FAXTEC1"]))) + @"</bean:FAXTEC1>
			<bean:G_EMATECI>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["G_EMATECI"]))) + @"</bean:G_EMATECI>

		</bean:rup>	");

    rs_Lotti.MoveFirst();

    //'-- Ciclo sui lotti
    while (!rs_Lotti.EOF)
    {
        //'-- Dati del LOTTO

        response.Write(@"<bean:listaLotti>
			<bean:W3OGGETTO2>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3OGGETTO2"]))) + @"</bean:W3OGGETTO2>
			<bean:W3CIG>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3CIG"]))) + @"</bean:W3CIG>

			<bean:W3SOMMA_UR>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3SOMMA_UR"]))) + @"</bean:W3SOMMA_UR>
			<bean:W3I_LOTTO>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3I_LOTTO"]))) + @"</bean:W3I_LOTTO>
			<bean:W3CPV>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3CPV"]))) + @"</bean:W3CPV>
			<bean:W3ID_SCEL2>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_SCEL2"]))) + @"</bean:W3ID_SCEL2>
			<bean:W3ID_CATE4>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_CATE4"]))) + @"</bean:W3ID_CATE4>
			<bean:W3MANOLO>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3MANOLO"]))) + @"</bean:W3MANOLO>
			<bean:W3TIPO_CON>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3TIPO_CON"]))) + @"</bean:W3TIPO_CON>
			<bean:W3MOD_GAR>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3MOD_GAR"]))) + @"</bean:W3MOD_GAR>");

        if (!String.IsNullOrEmpty(CStr(GetValueFromRS(rs_Lotti.Fields["W3LUOGO_IS"]))))
        {
            response.Write(@"<bean:W3LUOGO_IS>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3LUOGO_IS"]))) + @"</bean:W3LUOGO_IS>");
        }

        if (!String.IsNullOrEmpty(CStr(GetValueFromRS(rs_Lotti.Fields["W3LUOGO_NU"]))))
        {
            response.Write(@"<bean:W3LUOGO_NU>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3LUOGO_NU"]))) + @"</bean:W3LUOGO_NU>");
        }

        response.Write(@"<bean:W3ID_TIPO>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_TIPO"]))) + @"</bean:W3ID_TIPO>
			<bean:listaModalitaAcquisizioneFS>
				<bean:W3ID_APP04>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_APP04"]))) + @"</bean:W3ID_APP04>
			</bean:listaModalitaAcquisizioneFS>");

        if (!String.IsNullOrEmpty(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_APP05"]))))
        {
            response.Write(@"<bean:listaTipologiaLavoro>
				<bean:W3ID_APP05>" + xmlEncode(CStr(GetValueFromRS(rs_Lotti.Fields["W3ID_APP05"]))) + @"</bean:W3ID_APP05>
			</bean:listaTipologiaLavoro>");
        }

        response.Write(@"</bean:listaLotti>");
        rs_Lotti.MoveNext();
    }

    response.Write(@"<bean:pubblicitaGara>");

    if (!String.IsNullOrEmpty(CStr(GetValueFromRS(rs_Gara.Fields["W3GUCE1"]))))
    {
        response.Write(@"<bean:W3GUCE1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3GUCE1"]))) + @"</bean:W3GUCE1>");
    }

    if (!String.IsNullOrEmpty(CStr(GetValueFromRS(rs_Gara.Fields["W3GURI1"]))))
    {
        response.Write(@"<bean:W3GURI1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3GURI1"]))) + @"</bean:W3GURI1>");
    }

    response.Write(@"<bean:W3PROFILO1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3PROFILO1"]))) + @"</bean:W3PROFILO1>
			<bean:W3MIN1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3MIN1"]))) + @"</bean:W3MIN1>
			<bean:W3OSS1>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W3OSS1"]))) + @"</bean:W3OSS1>
		</bean:pubblicitaGara>

		
		<bean:centroDiCosto>
			<bean:W9CCCODICE>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W9CCCODICE"]))) + @"</bean:W9CCCODICE>
			<bean:W9CCDENOM>" + xmlEncode(CStr(GetValueFromRS(rs_Gara.Fields["W9CCDENOM"]))) + @"</bean:W9CCDENOM>		
		</bean:centroDiCosto>

	
	</bean:Gara>
    </bean:richiestaSincrona_IstanzaGara>            	
                    ]]>
                </bean:oggettoXML>
            </bean:garaLotti>
        </bean:istanziaGara>
    </soapenv:Body>
    </soapenv:Envelope>");


}
@Html.Raw(response.Out())