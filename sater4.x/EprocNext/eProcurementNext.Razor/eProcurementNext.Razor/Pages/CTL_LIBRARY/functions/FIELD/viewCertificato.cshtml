@page "/CTL_LIBRARY/functions/FIELD/viewCertificato.asp"
@inject eProcurementNext.Session.ISession session;
@using eProcurementNext.CommonDB
@using eProcurementNext.CommonModule;
@using static eProcurementNext.CommonModule.Basic;
@using eProcurementNext.BizDB;
@using eProcurementNext.HTML;
@using eProcurementNext.Application;
@using static eProcurementNext.HTML.BasicFunction;
@using Microsoft.VisualBasic;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.print_documentModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.DOCUMENT.CommonModel;
@using static eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.masterPageToolsModel;
@model eProcurementNext.Razor.Pages.CTL_LIBRARY.functions.FIELD.viewCertificatoModel
@using static eProcurementNext.Session.SessionMiddleware
@{
	IFormCollection? Request_Form = HttpContext.Request.HasFormContentType ? HttpContext.Request.Form : null;
	LoadSession(HttpContext, session);
	EprocResponse htmlToReturn = new(GetParamURL(HttpContext.Request.QueryString.ToString(), "XML_ATTACH_TYPE"));

	//'-- *********************************************************************
	//'-- * Versione=1&data=2012-05-23&Attvita=37854&Nominativo=FedericoLeone *
	//'-- *********************************************************************
	//
	//'-- PARAMETRI :
	//'-- * ATT_Hash     , chiave di aggancio per i nuovi allegati
	//'-- * attIdMsg     , chiave di aggancio per i vecchi allegati
	//'-- * attOrderFile , chiave di aggancio per i vecchi allegati
	//'-- * attIdObj     , chiave di aggancio per i vecchi allegati 
	objDoc = PrintDocument(session, htmlToReturn, HttpContext, Response,Request);//PrintDocument ok

	string strSql = "";
	string filtro = "";
	string idDoc = objDoc.mp_IDDoc;
	string infocert = "";
	string url = "";

	objDoc.UpdateContentInMem(session,Request_Form);

	string noPath = GetParamURL(Request.QueryString.ToString(), "NO_PATH").ToUpper();

	//'-- Compongo l'url per invocare l'aspx che farà fare il downloader dell'allegato senza la busta
	string downloadAtt = "../../../pdf.aspx?mode=ESCLUDI_BUSTA&ATT_HASH=" + CStr(GetParamURL(Request.QueryString.ToString(), "ATT_HASH"));
	downloadAtt = downloadAtt + "&ATTIDOBJ=" + CStr(GetParamURL(Request.QueryString.ToString(), "ATTIDOBJ"));

	string attHash = GetParamURL(Request.QueryString.ToString(), "ATT_HASH");

	//Filtro che passeremo al viewer
	filtro = "ATT_Hash='" + attHash.Replace("'", "''") + "'";

	var sqlParams = new Dictionary<string, object?>();
	sqlParams.Add("@ATT_Hash", attHash);

	//'-- condizione per i nuovi documento ( rimosso il codice per i documenti generici, non serve più )
	strSql = "SELECT id FROM CTL_SIGN_ATTACH_INFO with(nolock) where ATT_Hash=@ATT_Hash";

	TSRecordSet? rs = null;
	try
	{
		CommonDbFunctions cdb = new();
		rs = cdb.GetRSReadFromQuery_(strSql, ApplicationCommon.Application.ConnectionString, sqlParams);
	}
	catch
	{

	}

	//'-- Se ci sono certificati associati all'allegato
	if (rs != null && rs.RecordCount > 0)
	{
		//'-- Se c'è 1 solo certificato associato all'allegato
		if (rs.RecordCount == 1)
		{
			rs.MoveFirst();
			idDoc = CStr(GetValueFromRS(rs.Fields["id"]));

			if (noPath == "YES")
			{
				infocert = "../../document/document.asp?MODE=SHOW&JSCRIPT=INFO_FIRMA&DOCUMENT=VERIFICA_FIRMA_INFO&IDDOC=" + idDoc;

				infocert = infocert + "&lo=base";
			}
			else
			{
				url = "ctl_library/document/document.asp?MODE=SHOW&JSCRIPT=INFO_FIRMA&DOCUMENT=VERIFICA_FIRMA_INFO&IDDOC=" + idDoc;
				infocert = "../../../ctl_library/path.asp?RESET=NO&url=" + UrlEncode(url + "&lo=base") + "&KEY=document";
			}
		}
		else
		{
			//'-- Se siamo nel caso di firma multipla apriamo il viewer con l'elenco dei certificati associati

			if (noPath == "YES")
			{
				infocert = "../../../DASHBOARD/Viewer.asp?ModGriglia=LISTA_CERTIFICATIGriglia&TOOLBAR=DASHBOARD_LISTA_CERTIFICATI_TOOLBAR&Table=CTL_SIGN_ATTACH_INFO&IDENTITY=Id&DOCUMENT=VERIFICA_FIRMA_INFO&AreaAdd=no&ShowExit=0&Caption=Lista certificati&ACTIVESEL=1&AreaFiltro=no&FilterHide=" + UrlEncode(filtro);

				infocert = infocert + "&lo=base";
			}
			else
			{
				url = "DASHBOARD/Viewer.asp?ModGriglia=LISTA_CERTIFICATIGriglia&TOOLBAR=DASHBOARD_LISTA_CERTIFICATI_TOOLBAR&Table=CTL_SIGN_ATTACH_INFO&IDENTITY=Id&DOCUMENT=VERIFICA_FIRMA_INFO&AreaAdd=no&ShowExit=0&Caption=Lista certificati&ACTIVESEL=1&AreaFiltro=no&FilterHide=" + UrlEncode(filtro);
				infocert = "../../../ctl_library/path.asp?RESET=NO&url=" + UrlEncode(url + "&lo=base") + "&KEY=viewer";
			}
		}
	}
	else
	{	
			//'--setto il messaggio in sessione per essere visualizzato sotto forma di modale
			session["MSG_ERROR"] = "MSG=Nessun certificato associato&ML=yes&TITLE=INFO&CAPTION=INFO&ICO=1";

			//'--torno sulla pagina chiamante tramite le molliche di pane
			toBreadCrumb("../../../", 0,session,Response);
	}
	
	throw new ResponseRedirectException(infocert, Response);
}