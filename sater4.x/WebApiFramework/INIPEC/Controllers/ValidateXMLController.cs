using System;
using System.Configuration;
using System.IO;
using System.Web.Http;
using INIPEC.Library;
using Newtonsoft.Json.Linq;

namespace INIPEC.Controllers
{

    public class ValidateXMLController : ApiController
    {
        public string BasePath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "eForms\\XSD\\schemas\\maindoc\\");

        [HttpGet]
        /// Il seguente metodo prende in input 4 parametri: se i 2 bool sono settati a 'true' indicano che le 2 strighe vanno trattate come path 
        /// (relativi, a partire dalla directory del progetto)
        /// oppure se sono settati a false il metodo si aspetta il corpo dell'xml/xsd in input per intero come stringa.
        /// NB: in caso di XSD o XML linkati in più file, si consiglia di mantenere l'approccio a path
        public IHttpActionResult ValidateXML(string Xml, string Xsd, bool isXmlPath, bool isXsdPath)
        {
            XMLValidation Validation = new XMLValidation();
            XMLValidationOutput Result = new XMLValidationOutput();

            //Errori Cablati
            string XSDPath = "0#Il percorso fornito per il file XSD risulta incorretto. Controlla se il file esiste.";
            string XMLPath = "0#Il percorso fornito per il file XML risulta incorretto. Controlla se il file esiste.";
            string XSD = "0#Errore nel recupero dell'XSD.";
            string ValidateXML = "1#Errore di validazione file XML.";
            string ReadXML = "1#Errore di lettura file XML con schema XSD.";

            try
            {
                Result = Validation.ValidateXML(Xml, Xsd, isXmlPath, isXsdPath);

                if (!Result.Esit)
                {
                    if (Result.Error != Errors.RuntimeException)
                    {
                        if (!string.IsNullOrEmpty(ConfigurationManager.AppSettings[$"XMLValidation.Error.{Result.Error}"]))
                        {
                            return Ok(ConfigurationManager.AppSettings[$"XMLValidation.Error.{Result.Error}"]);
                        }
                        else
                        {
                            //Fallback nel caso in cui non ci sono i parametri nel webconfig
                            switch (Result.Error)
                            {
                                case Errors.XSDPath:
                                    return Ok(XSDPath);
                                case Errors.XMLPath:
                                    return Ok(XMLPath);
                                case Errors.XSD:
                                    return Ok(XSD);
                                case Errors.ValidateXML:
                                    return Ok(ValidateXML);
                                case Errors.ReadXML:
                                    return Ok(ReadXML);
                            }
                        }
                    }
                    else
                    {
                        throw new Exception(Result.RuntimeException);
                    }
                }

                return Ok("1#OK");
            }
            catch (Exception ex)
            {
                return InternalServerError(ex);
            }
        }

        [HttpGet]
        /// ENDPOINT SENZA PARAMETRI usato per testare il funzionamento della libreria
        public IHttpActionResult ValidateXML(string TipoErrore)
        {
            XMLValidation Validation = new XMLValidation();
            XMLValidationOutput Result = new XMLValidationOutput();

            //Errori Cablati
            string XSDPath = "0#Il percorso fornito per il file XSD risulta incorretto. Controlla se il file esiste.";
            string XMLPath = "0#Il percorso fornito per il file XML risulta incorretto. Controlla se il file esiste.";
            string XSD = "0#Errore nel recupero dell'XSD.";
            string ValidateXML = "1#Errore di validazione file XML.";
            string ReadXML = "1#Errore di lettura file XML con schema XSD.";

            //Parametri Cablati
            string Xml = string.Empty;
            string Xsd = "UBL-ContractNotice-2.3.xsd";
            bool isXmlPath = false;
            bool isXsdPath = true;

            //PER TEST: tipo di errore da generare
            switch (TipoErrore)
            {
                case "Contenuto XML non conforme allo schema":
                    Xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<urn:ContractNotice xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\r\n                     xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\r\n                     xmlns:efac=\"http://data.europa.eu/p27/eforms-ubl-extension-aggregate-components/1\"\r\n                     xmlns:efbc=\"http://data.europa.eu/p27/eforms-ubl-extension-basic-components/1\"\r\n                     xmlns:efext=\"http://data.europa.eu/p27/eforms-ubl-extensions/1\"\r\n                     xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\r\n                     xmlns:urn=\"urn:oasis:names:specification:ubl:schema:xsd:ContractNotice-2\">\r\n   <ext:UBLExtensions>\r\n      <ext:UBLExtension>\r\n         <ext:ExtensionContent>\r\n            <efext:EformsExtension>\r\n               <efac:NoticeSubType>\r\n                  <cbc:SubTypeCode listName=\"notice-subtype\">16</cbc:SubTypeCode>\r\n               </efac:NoticeSubType>\r\n               <efac:Organizations>\r\n                  <efac:Organization>\r\n                     <efac:Company>\r\n                        <cac:PartyIdentification>\r\n                           <cbc:ID>ORG-0001</cbc:ID>\r\n                        </cac:PartyIdentification>\r\n                        <cac:PartyName>\r\n                           <cbc:Name languageID=\"ITA\">Organizzazione name</cbc:Name>\r\n                        </cac:PartyName>\r\n                        <cac:PostalAddress>\r\n                           <cbc:CityName>Napoli</cbc:CityName>\r\n                           <cac:Country>\r\n                              <cbc:IdentificationCode listName=\"country\">ITA</cbc:IdentificationCode>\r\n                           </cac:Country>\r\n                        </cac:PostalAddress>\r\n                        <cac:PartyLegalEntity>\r\n                           <cbc:CompanyID>34534543535</cbc:CompanyID>\r\n                        </cac:PartyLegalEntity>\r\n                        <cac:Contact>\r\n                           <cbc:Telephone>2342211456</cbc:Telephone>\r\n                           <cbc:ElectronicMail>email@referente.it</cbc:ElectronicMail>\r\n                        </cac:Contact>\r\n                     </efac:Company>\r\n                  </efac:Organization>\r\n               </efac:Organizations>\r\n            </efext:EformsExtension>\r\n         </ext:ExtensionContent>\r\n      </ext:UBLExtension>\r\n   </ext:UBLExtensions>\r\n   <cbc:UBLVersionID>2.3</cbc:UBLVersionID>\r\n   <cbc:CustomizationID>eforms-sdk-1.8</cbc:CustomizationID>\r\n   <cbc:ID schemeName=\"notice-id\">bf5b362d-0764-4257-8071-fb352d45fb78</cbc:ID>\r\n   <cbc:ContractFolderID>ac8cbfb2-dcdc-4c25-861e-06ad1f79ef9e</cbc:ContractFolderID>\r\n   <cbc:IssueDate>2023-09-04Z</cbc:IssueDate>\r\n   <cbc:IssueTime>11:20:51Z</cbc:IssueTime>\r\n   <cbc:VersionID>01</cbc:VersionID>\r\n   <cbc:RegulatoryDomain>32014L0024</cbc:RegulatoryDomain>\r\n   <cbc:NoticeTypeCode listName=\"competition\">cn-standard</cbc:NoticeTypeCode>\r\n   <cbc:NoticeLanguageCode listName=\"language\">ITA</cbc:NoticeLanguageCode>\r\n   <cac:ContractingParty>\r\n      <cac:ContractingPartyType>\r\n         <cbc:PartyTypeCode listName=\"buyer-legal-type\">body-pl-cga</cbc:PartyTypeCode>\r\n      </cac:ContractingPartyType>\r\n      <cac:ContractingActivity>\r\n         <cbc:ActivityTypeCode listName=\"authority-activity\">defence</cbc:ActivityTypeCode>\r\n      </cac:ContractingActivity>\r\n      <cac:Party>\r\n         <cac:PartyIdentification>\r\n            <cbc:ID>ORG-0001</cbc:ID>\r\n         </cac:PartyIdentification>\r\n      </cac:Party>\r\n   </cac:ContractingParty>\r\n   <cac:TenderingTerms>\r\n      <cac:TendererQualificationRequest>\r\n         <cac:SpecificTendererRequirement>\r\n            <cbc:TendererRequirementTypeCode listName=\"exclusion-ground\">corruption</cbc:TendererRequirementTypeCode>\r\n            <cbc:Description languageID=\"ITA\">descrizione di corruzione</cbc:Description>\r\n         </cac:SpecificTendererRequirement>\r\n      </cac:TendererQualificationRequest>\r\n   </cac:TenderingTerms>\r\n   <cac:TenderingProcess>\r\n      <ext:UBLExtensions>\r\n         <ext:UBLExtension>\r\n            <ext:ExtensionContent>\r\n               <efext:EformsExtension>\r\n                  <efbc:ProcedureRelaunchIndicator>false</efbc:ProcedureRelaunchIndicator>\r\n               </efext:EformsExtension>\r\n            </ext:ExtensionContent>\r\n         </ext:UBLExtension>\r\n      </ext:UBLExtensions>\r\n      <cbc:ProcedureCode listName=\"procurement-procedure-type\">open</cbc:ProcedureCode>\r\n      <cac:ProcessJustification>\r\n         <cbc:ProcessReasonCode listName=\"accelerated-procedure\">false</cbc:ProcessReasonCode>\r\n      </cac:ProcessJustification>\r\n   </cac:TenderingProcess>\r\n   <cac:ProcurementProject>\r\n      <cbc:Name languagdaeID=\"ITA\">Titolo della procedura</cbc:Name>\r\n      <cbc:Description languageeID=\"ITA\">Descrizione della procedura</cbc:Description>\r\n      <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n      <cac:MainCommodityClassification>\r\n         <cbc:ItemClassificationCode listName=\"cpv\">64110000</cbc:ItemClassificationCode>\r\n      </cac:MainCommodityClassification>\r\n   </cac:ProcurementProject>\r\n   <cac:ProcurementProjectLot>\r\n      <cbc:ID schemedaName=\"Lot\">LOT-0001</cbc:ID>\r\n      <cac:TenderingTerms>\r\n         <ext:UBLExtensions>\r\n            <ext:UBLExtension>\r\n               <ext:ExtensionContent>\r\n                  <efext:EformsExtension>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">tp-abil</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">ef-stand</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                  </efext:EformsExtension>\r\n               </ext:ExtensionContent>\r\n            </ext:UBLExtension>\r\n         </ext:UBLExtensions>\r\n         <cbc:FundingProgramCode listName=\"eu-funded\">eu-funds</cbc:FundingProgramCode>\r\n         <cac:CallForTendersDocumentReference>\r\n            <cbc:ID>_DEFAULT_VALUE_CHANGE_ME_</cbc:ID>\r\n            <cbc:DocumentType>non-restricted-document</cbc:DocumentType>\r\n            <cac:Attachment>\r\n               <cac:ExternalReference>\r\n                  <cbc:URI>https://enotices2.preview.ted.europa.eu/</cbc:URI>\r\n               </cac:ExternalReference>\r\n            </cac:Attachment>\r\n         </cac:CallForTendersDocumentReference>\r\n         <cac:TendererQualificationRequest>\r\n            <cac:SpecificTendererRequirement>\r\n               <cbc:TendererRequirementTypeCode listName=\"reserved-procurement\">none</cbc:TendererRequirementTypeCode>\r\n            </cac:SpecificTendererRequirement>\r\n         </cac:TendererQualificationRequest>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"reserved-execution\">no</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"einvoicing\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"conditions\">performance</cbc:ExecutionRequirementCode>\r\n            <cbc:Description languageID=\"ITA\">grtgertretr</cbc:Description>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"ecatalog-submission\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:AppealTerms>\r\n            <cac:AppealReceiverParty>\r\n               <cac:PartyIdentification>\r\n                  <cbc:ID>ORG-0001</cbc:ID>\r\n               </cac:PartyIdentification>\r\n            </cac:AppealReceiverParty>\r\n         </cac:AppealTerms>\r\n         <cac:Language>\r\n            <cbc:ID>ITA</cbc:ID>\r\n         </cac:Language>\r\n         <cac:PostAwardProcess>\r\n            <cbc:ElectronicOrderUsageIndicator>true</cbc:ElectronicOrderUsageIndicator>\r\n            <cbc:ElectronicPaymentUsageIndicator>true</cbc:ElectronicPaymentUsageIndicator>\r\n         </cac:PostAwardProcess>\r\n      </cac:TenderingTerms>\r\n      <cac:TenderingProcess>\r\n         <cbc:SubmissionMethodCode listName=\"esubmission\">required</cbc:SubmissionMethodCode>\r\n         <cbc:GovernmentAgreementConstraintIndicator>false</cbc:GovernmentAgreementConstraintIndicator>\r\n         <cac:TenderSubmissionDeadlinePeriod>\r\n            <cbc:EndDate>2023-09-29+02:00</cbc:EndDate>\r\n            <cbc:EndTime>12:00:00+02:00</cbc:EndTime>\r\n         </cac:TenderSubmissionDeadlinePeriod>\r\n         <cac:AuctionTerms>\r\n            <cbc:AuctionConstraintIndicator>false</cbc:AuctionConstraintIndicator>\r\n         </cac:AuctionTerms>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"framework-agreement\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"dps-usage\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n      </cac:TenderingProcess>\r\n      <cac:ProcurementProject>\r\n         <cbc:ID>1</cbc:ID>\r\n         <cbc:Name languageID=\"ITA\">Lotto</cbc:Name>\r\n         <cbc:Description languageID=\"ITA\">Descrizione del lotto</cbc:Description>\r\n         <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n         <cac:MainCommodityClassification>\r\n            <cbc:ItemClassificationCode listName=\"cpv\">98111000</cbc:ItemClassificationCode>\r\n         </cac:MainCommodityClassification>\r\n      </cac:ProcurementProject>\r\n   </cac:ProcurementProjectLot>\r\n</urn:ContractNotice>\r\n";
                    break;
                case "Contenuto XML corrotto":
                    Xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<urn:ContractNotice xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\r\n                     xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\r\n                     xmlns:efac=\"http://data.europa.eu/p27/eforms-ubl-extension-aggregate-components/1\"\r\n                     xmlns:efbc=\"http://data.europa.eu/p27/eforms-ubl-extension-basic-components/1\"\r\n                     xmlns:efext=\"http://data.europa.eu/p27/eforms-ubl-extensions/1\"\r\n                     xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\r\n                     xmlns:urn=\"urn:oasis:names:specification:ubl:schema:xsd:ContractNotice-2\">\r\n   <ext:UBLExtensions>\r\n      <ext:UBLExtension>\r\n         <ext:ExtensionContent>\r\n            <efext:EformsExtension>\r\n                </efac:NoticeSubType>\r\n               <efac:Organizations>\r\n                  <efac:Organization>\r\n                     <efac:Company>\r\n                        <cac:PartyIdentification>\r\n                           <cbc:ID>ORG-0001</cbc:ID>\r\n                        </cac:PartyIdentification>\r\n                        <cac:PartyName>\r\n                           <cbc:Name languageID=\"ITA\">Organizzazione name</cbc:Name>\r\n                        </cac:PartyName>\r\n                        <cac:PostalAddress>\r\n                           <cbc:CityName>Napoli</cbc:CityName>\r\n                           <cac:Country>\r\n                              <cbc:IdentificationCode listName=\"country\">ITA</cbc:IdentificationCode>\r\n                           </cac:Country>\r\n                        </cac:PostalAddress>\r\n                        <cac:PartyLegalEntity>\r\n                           <cbc:CompanyID>34534543535</cbc:CompanyID>\r\n                        </cac:PartyLegalEntity>\r\n                        <cac:Contact>\r\n                           <cbc:Telephone>2342211456</cbc:Telephone>\r\n                           <cbc:ElectronicMail>email@referente.it</cbc:ElectronicMail>\r\n                        </cac:Contact>\r\n                     </efac:Company>\r\n                  </efac:Organization>\r\n               </efac:Organizations>\r\n            </efext:EformsExtension>\r\n         </ext:ExtensionContent>\r\n      </ext:UBLExtension>\r\n   </ext:UBLExtensions>\r\n   <cbc:UBLVersionID>2.3</cbc:UBLVersionID>\r\n   <cbc:CustomizationID>eforms-sdk-1.8</cbc:CustomizationID>\r\n   <cbc:ID schemeName=\"notice-id\">bf5b362d-0764-4257-8071-fb352d45fb78</cbc:ID>\r\n   <cbc:ContractFolderID>ac8cbfb2-dcdc-4c25-861e-06ad1f79ef9e</cbc:ContractFolderID>\r\n   <cbc:IssueDate>2023-09-04Z</cbc:IssueDate>\r\n   <cbc:IssueTime>11:20:51Z</cbc:IssueTime>\r\n   <cbc:VersionID>01</cbc:VersionID>\r\n   <cbc:RegulatoryDomain>32014L0024</cbc:RegulatoryDomain>\r\n   <cbc:NoticeTypeCode listName=\"competition\">cn-standard</cbc:NoticeTypeCode>\r\n   <cbc:NoticeLanguageCode listName=\"language\">ITA</cbc:NoticeLanguageCode>\r\n   <cac:ContractingParty>\r\n      <cac:ContractingPartyType>\r\n         <cbc:PartyTypeCode listName=\"buyer-legal-type\">body-pl-cga</cbc:PartyTypeCode>\r\n      </cac:ContractingPartyType>\r\n      <cac:ContractingActivity>\r\n         <cbc:ActivityTypeCode listName=\"authority-activity\">defence</cbc:ActivityTypeCode>\r\n      </cac:ContractingActivity>\r\n      <cac:Party>\r\n         <cac:PartyIdentification>\r\n            <cbc:ID>ORG-0001</cbc:ID>\r\n         </cac:PartyIdentification>\r\n      </cac:Party>\r\n   </cac:ContractingParty>\r\n   <cac:TenderingTerms>\r\n      <cac:TendererQualificationRequest>\r\n         <cac:SpecificTendererRequirement>\r\n            <cbc:TendererRequirementTypeCode listName=\"exclusion-ground\">corruption</cbc:TendererRequirementTypeCode>\r\n            <cbc:Description languageID=\"ITA\">descrizione di corruzione</cbc:Description>\r\n         </cac:SpecificTendererRequirement>\r\n      </cac:TendererQualificationRequest>\r\n   </cac:TenderingTerms>\r\n   <cac:TenderingProcess>\r\n      <ext:UBLExtensions>\r\n         <ext:UBLExtension>\r\n            <ext:ExtensionContent>\r\n               <efext:EformsExtension>\r\n                  <efbc:ProcedureRelaunchIndicator>false</efbc:ProcedureRelaunchIndicator>\r\n               </efext:EformsExtension>\r\n            </ext:ExtensionContent>\r\n         </ext:UBLExtension>\r\n      </ext:UBLExtensions>\r\n      <cbc:ProcedureCode listName=\"procurement-procedure-type\">open</cbc:ProcedureCode>\r\n      <cac:ProcessJustification>\r\n         <cbc:ProcessReasonCode listName=\"accelerated-procedure\">false</cbc:ProcessReasonCode>\r\n      </cac:ProcessJustification>\r\n   </cac:TenderingProcess>\r\n   <cac:ProcurementProject>\r\n      <cbc:Name languageID=\"ITA\">Titolo della procedura</cbc:Name>\r\n      <cbc:Description languageID=\"ITA\">Descrizione della procedura</cbc:Description>\r\n      <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n      <cac:MainCommodityClassification>\r\n         <cbc:ItemClassificationCode listName=\"cpv\">64110000</cbc:ItemClassificationCode>\r\n      </cac:MainCommodityClassification>\r\n   </cac:ProcurementProject>\r\n   <cac:ProcurementProjectLot>\r\n      <cbc:ID schemeName=\"Lot\">LOT-0001</cbc:ID>\r\n      <cac:TenderingTerms>\r\n         <ext:UBLExtensions>\r\n            <ext:UBLExtension>\r\n               <ext:ExtensionContent>\r\n                  <efext:EformsExtension>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">tp-abil</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">ef-stand</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                  </efext:EformsExtension>\r\n               </ext:ExtensionContent>\r\n            </ext:UBLExtension>\r\n         </ext:UBLExtensions>\r\n         <cbc:FundingProgramCode listName=\"eu-funded\">eu-funds</cbc:FundingProgramCode>\r\n         <cac:CallForTendersDocumentReference>\r\n            <cbc:ID>_DEFAULT_VALUE_CHANGE_ME_</cbc:ID>\r\n            <cbc:DocumentType>non-restricted-document</cbc:DocumentType>\r\n            <cac:Attachment>\r\n               <cac:ExternalReference>\r\n                  <cbc:URI>https://enotices2.preview.ted.europa.eu/</cbc:URI>\r\n               </cac:ExternalReference>\r\n            </cac:Attachment>\r\n         </cac:CallForTendersDocumentReference>\r\n         <cac:TendererQualificationRequest>\r\n            <cac:SpecificTendererRequirement>\r\n               <cbc:TendererRequirementTypeCode listName=\"reserved-procurement\">none</cbc:TendererRequirementTypeCode>\r\n            </cac:SpecificTendererRequirement>\r\n         </cac:TendererQualificationRequest>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"reserved-execution\">no</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"einvoicing\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"conditions\">performance</cbc:ExecutionRequirementCode>\r\n            <cbc:Description languageID=\"ITA\">grtgertretr</cbc:Description>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"ecatalog-submission\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:AppealTerms>\r\n            <cac:AppealReceiverParty>\r\n               <cac:PartyIdentification>\r\n                  <cbc:ID>ORG-0001</cbc:ID>\r\n               </cac:PartyIdentification>\r\n            </cac:AppealReceiverParty>\r\n         </cac:AppealTerms>\r\n         <cac:Language>\r\n            <cbc:ID>ITA</cbc:ID>\r\n         </cac:Language>\r\n         <cac:PostAwardProcess>\r\n            <cbc:ElectronicOrderUsageIndicator>true</cbc:ElectronicOrderUsageIndicator>\r\n            <cbc:ElectronicPaymentUsageIndicator>true</cbc:ElectronicPaymentUsageIndicator>\r\n         </cac:PostAwardProcess>\r\n      </cac:TenderingTerms>\r\n      <cac:TenderingProcess>\r\n         <cbc:SubmissionMethodCode listName=\"esubmission\">required</cbc:SubmissionMethodCode>\r\n         <cbc:GovernmentAgreementConstraintIndicator>false</cbc:GovernmentAgreementConstraintIndicator>\r\n         <cac:TenderSubmissionDeadlinePeriod>\r\n            <cbc:EndDate>2023-09-29+02:00</cbc:EndDate>\r\n            <cbc:EndTime>12:00:00+02:00</cbc:EndTime>\r\n         </cac:TenderSubmissionDeadlinePeriod>\r\n         <cac:AuctionTerms>\r\n            <cbc:AuctionConstraintIndicator>false</cbc:AuctionConstraintIndicator>\r\n         </cac:AuctionTerms>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"framework-agreement\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"dps-usage\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n      </cac:TenderingProcess>\r\n      <cac:ProcurementProject>\r\n         <cbc:ID>1</cbc:ID>\r\n         <cbc:Name languageID=\"ITA\">Lotto</cbc:Name>\r\n         <cbc:Description languageID=\"ITA\">Descrizione del lotto</cbc:Description>\r\n         <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n         <cac:MainCommodityClassification>\r\n            <cbc:ItemClassificationCode listName=\"cpv\">98111000</cbc:ItemClassificationCode>\r\n         </cac:MainCommodityClassification>\r\n      </cac:ProcurementProject>\r\n   </cac:ProcurementProjectLot>\r\n</urn:ContractNotice>";
                    break;
                default:
                    Xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<urn:ContractNotice xmlns:cac=\"urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2\"\r\n                     xmlns:cbc=\"urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2\"\r\n                     xmlns:efac=\"http://data.europa.eu/p27/eforms-ubl-extension-aggregate-components/1\"\r\n                     xmlns:efbc=\"http://data.europa.eu/p27/eforms-ubl-extension-basic-components/1\"\r\n                     xmlns:efext=\"http://data.europa.eu/p27/eforms-ubl-extensions/1\"\r\n                     xmlns:ext=\"urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2\"\r\n                     xmlns:urn=\"urn:oasis:names:specification:ubl:schema:xsd:ContractNotice-2\">\r\n   <ext:UBLExtensions>\r\n      <ext:UBLExtension>\r\n         <ext:ExtensionContent>\r\n            <efext:EformsExtension>\r\n               <efac:NoticeSubType>\r\n                  <cbc:SubTypeCode listName=\"notice-subtype\">16</cbc:SubTypeCode>\r\n               </efac:NoticeSubType>\r\n               <efac:Organizations>\r\n                  <efac:Organization>\r\n                     <efac:Company>\r\n                        <cac:PartyIdentification>\r\n                           <cbc:ID>ORG-0001</cbc:ID>\r\n                        </cac:PartyIdentification>\r\n                        <cac:PartyName>\r\n                           <cbc:Name languageID=\"ITA\">Organizzazione name</cbc:Name>\r\n                        </cac:PartyName>\r\n                        <cac:PostalAddress>\r\n                           <cbc:CityName>Napoli</cbc:CityName>\r\n                           <cac:Country>\r\n                              <cbc:IdentificationCode listName=\"country\">ITA</cbc:IdentificationCode>\r\n                           </cac:Country>\r\n                        </cac:PostalAddress>\r\n                        <cac:PartyLegalEntity>\r\n                           <cbc:CompanyID>34534543535</cbc:CompanyID>\r\n                        </cac:PartyLegalEntity>\r\n                        <cac:Contact>\r\n                           <cbc:Telephone>2342211456</cbc:Telephone>\r\n                           <cbc:ElectronicMail>email@referente.it</cbc:ElectronicMail>\r\n                        </cac:Contact>\r\n                     </efac:Company>\r\n                  </efac:Organization>\r\n               </efac:Organizations>\r\n            </efext:EformsExtension>\r\n         </ext:ExtensionContent>\r\n      </ext:UBLExtension>\r\n   </ext:UBLExtensions>\r\n   <cbc:UBLVersionID>2.3</cbc:UBLVersionID>\r\n   <cbc:CustomizationID>eforms-sdk-1.8</cbc:CustomizationID>\r\n   <cbc:ID schemeName=\"notice-id\">bf5b362d-0764-4257-8071-fb352d45fb78</cbc:ID>\r\n   <cbc:ContractFolderID>ac8cbfb2-dcdc-4c25-861e-06ad1f79ef9e</cbc:ContractFolderID>\r\n   <cbc:IssueDate>2023-09-04Z</cbc:IssueDate>\r\n   <cbc:IssueTime>11:20:51Z</cbc:IssueTime>\r\n   <cbc:VersionID>01</cbc:VersionID>\r\n   <cbc:RegulatoryDomain>32014L0024</cbc:RegulatoryDomain>\r\n   <cbc:NoticeTypeCode listName=\"competition\">cn-standard</cbc:NoticeTypeCode>\r\n   <cbc:NoticeLanguageCode listName=\"language\">ITA</cbc:NoticeLanguageCode>\r\n   <cac:ContractingParty>\r\n      <cac:ContractingPartyType>\r\n         <cbc:PartyTypeCode listName=\"buyer-legal-type\">body-pl-cga</cbc:PartyTypeCode>\r\n      </cac:ContractingPartyType>\r\n      <cac:ContractingActivity>\r\n         <cbc:ActivityTypeCode listName=\"authority-activity\">defence</cbc:ActivityTypeCode>\r\n      </cac:ContractingActivity>\r\n      <cac:Party>\r\n         <cac:PartyIdentification>\r\n            <cbc:ID>ORG-0001</cbc:ID>\r\n         </cac:PartyIdentification>\r\n      </cac:Party>\r\n   </cac:ContractingParty>\r\n   <cac:TenderingTerms>\r\n      <cac:TendererQualificationRequest>\r\n         <cac:SpecificTendererRequirement>\r\n            <cbc:TendererRequirementTypeCode listName=\"exclusion-ground\">corruption</cbc:TendererRequirementTypeCode>\r\n            <cbc:Description languageID=\"ITA\">descrizione di corruzione</cbc:Description>\r\n         </cac:SpecificTendererRequirement>\r\n      </cac:TendererQualificationRequest>\r\n   </cac:TenderingTerms>\r\n   <cac:TenderingProcess>\r\n      <ext:UBLExtensions>\r\n         <ext:UBLExtension>\r\n            <ext:ExtensionContent>\r\n               <efext:EformsExtension>\r\n                  <efbc:ProcedureRelaunchIndicator>false</efbc:ProcedureRelaunchIndicator>\r\n               </efext:EformsExtension>\r\n            </ext:ExtensionContent>\r\n         </ext:UBLExtension>\r\n      </ext:UBLExtensions>\r\n      <cbc:ProcedureCode listName=\"procurement-procedure-type\">open</cbc:ProcedureCode>\r\n      <cac:ProcessJustification>\r\n         <cbc:ProcessReasonCode listName=\"accelerated-procedure\">false</cbc:ProcessReasonCode>\r\n      </cac:ProcessJustification>\r\n   </cac:TenderingProcess>\r\n   <cac:ProcurementProject>\r\n      <cbc:Name languageID=\"ITA\">Titolo della procedura</cbc:Name>\r\n      <cbc:Description languageID=\"ITA\">Descrizione della procedura</cbc:Description>\r\n      <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n      <cac:MainCommodityClassification>\r\n         <cbc:ItemClassificationCode listName=\"cpv\">64110000</cbc:ItemClassificationCode>\r\n      </cac:MainCommodityClassification>\r\n   </cac:ProcurementProject>\r\n   <cac:ProcurementProjectLot>\r\n      <cbc:ID schemeName=\"Lot\">LOT-0001</cbc:ID>\r\n      <cac:TenderingTerms>\r\n         <ext:UBLExtensions>\r\n            <ext:UBLExtension>\r\n               <ext:ExtensionContent>\r\n                  <efext:EformsExtension>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">tp-abil</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                     <efac:SelectionCriteria>\r\n                        <cbc:CriterionTypeCode listName=\"selection-criterion\">ef-stand</cbc:CriterionTypeCode>\r\n                     </efac:SelectionCriteria>\r\n                  </efext:EformsExtension>\r\n               </ext:ExtensionContent>\r\n            </ext:UBLExtension>\r\n         </ext:UBLExtensions>\r\n         <cbc:FundingProgramCode listName=\"eu-funded\">eu-funds</cbc:FundingProgramCode>\r\n         <cac:CallForTendersDocumentReference>\r\n            <cbc:ID>_DEFAULT_VALUE_CHANGE_ME_</cbc:ID>\r\n            <cbc:DocumentType>non-restricted-document</cbc:DocumentType>\r\n            <cac:Attachment>\r\n               <cac:ExternalReference>\r\n                  <cbc:URI>https://enotices2.preview.ted.europa.eu/</cbc:URI>\r\n               </cac:ExternalReference>\r\n            </cac:Attachment>\r\n         </cac:CallForTendersDocumentReference>\r\n         <cac:TendererQualificationRequest>\r\n            <cac:SpecificTendererRequirement>\r\n               <cbc:TendererRequirementTypeCode listName=\"reserved-procurement\">none</cbc:TendererRequirementTypeCode>\r\n            </cac:SpecificTendererRequirement>\r\n         </cac:TendererQualificationRequest>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"reserved-execution\">no</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"einvoicing\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"conditions\">performance</cbc:ExecutionRequirementCode>\r\n            <cbc:Description languageID=\"ITA\">grtgertretr</cbc:Description>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:ContractExecutionRequirement>\r\n            <cbc:ExecutionRequirementCode listName=\"ecatalog-submission\">required</cbc:ExecutionRequirementCode>\r\n         </cac:ContractExecutionRequirement>\r\n         <cac:AppealTerms>\r\n            <cac:AppealReceiverParty>\r\n               <cac:PartyIdentification>\r\n                  <cbc:ID>ORG-0001</cbc:ID>\r\n               </cac:PartyIdentification>\r\n            </cac:AppealReceiverParty>\r\n         </cac:AppealTerms>\r\n         <cac:Language>\r\n            <cbc:ID>ITA</cbc:ID>\r\n         </cac:Language>\r\n         <cac:PostAwardProcess>\r\n            <cbc:ElectronicOrderUsageIndicator>true</cbc:ElectronicOrderUsageIndicator>\r\n            <cbc:ElectronicPaymentUsageIndicator>true</cbc:ElectronicPaymentUsageIndicator>\r\n         </cac:PostAwardProcess>\r\n      </cac:TenderingTerms>\r\n      <cac:TenderingProcess>\r\n         <cbc:SubmissionMethodCode listName=\"esubmission\">required</cbc:SubmissionMethodCode>\r\n         <cbc:GovernmentAgreementConstraintIndicator>false</cbc:GovernmentAgreementConstraintIndicator>\r\n         <cac:TenderSubmissionDeadlinePeriod>\r\n            <cbc:EndDate>2023-09-29+02:00</cbc:EndDate>\r\n            <cbc:EndTime>12:00:00+02:00</cbc:EndTime>\r\n         </cac:TenderSubmissionDeadlinePeriod>\r\n         <cac:AuctionTerms>\r\n            <cbc:AuctionConstraintIndicator>false</cbc:AuctionConstraintIndicator>\r\n         </cac:AuctionTerms>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"framework-agreement\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n         <cac:ContractingSystem>\r\n            <cbc:ContractingSystemTypeCode listName=\"dps-usage\">none</cbc:ContractingSystemTypeCode>\r\n         </cac:ContractingSystem>\r\n      </cac:TenderingProcess>\r\n      <cac:ProcurementProject>\r\n         <cbc:ID>1</cbc:ID>\r\n         <cbc:Name languageID=\"ITA\">Lotto</cbc:Name>\r\n         <cbc:Description languageID=\"ITA\">Descrizione del lotto</cbc:Description>\r\n         <cbc:ProcurementTypeCode listName=\"contract-nature\">services</cbc:ProcurementTypeCode>\r\n         <cac:MainCommodityClassification>\r\n            <cbc:ItemClassificationCode listName=\"cpv\">98111000</cbc:ItemClassificationCode>\r\n         </cac:MainCommodityClassification>\r\n      </cac:ProcurementProject>\r\n   </cac:ProcurementProjectLot>\r\n</urn:ContractNotice>";
                    break;
            }

            try
            {
                Result = Validation.ValidateXML(Xml, Xsd, isXmlPath, isXsdPath);

                if (!Result.Esit)
                {
                    if (Result.Error != Errors.RuntimeException)
                    {
                        if (!string.IsNullOrEmpty(ConfigurationManager.AppSettings[$"XMLValidation.Error.{Result.Error}"]))
                        {
                            return Ok(ConfigurationManager.AppSettings[$"XMLValidation.Error.{Result.Error}"]);
                        }
                        else
                        {
                            //Fallback nel caso in cui non ci sono i parametri nel webconfig
                            switch (Result.Error)
                            {
                                case Errors.XSDPath:
                                    return Ok(XSDPath);
                                case Errors.XMLPath:
                                    return Ok(XMLPath);
                                case Errors.XSD:
                                    return Ok(XSD);
                                case Errors.ValidateXML:
                                    return Ok(ValidateXML);
                                case Errors.ReadXML:
                                    return Ok(ReadXML);
                            }
                        }
                    }
                    else
                    {
                        throw new Exception(Result.RuntimeException);
                    }
                }

                return Ok("1#OK");
            }
            catch (Exception ex)
            {
                return InternalServerError(ex);
            }
        }
    }
}